<h2 class="mb-4">Configurações do Sistema</h2>

<div class="card settings-card mb-4">
    <div class="card-body">
        <h4 class="card-title mb-4">Gerenciamento de Logs</h4>
        <p class="text-danger">Atenção: Esta ação irá apagar permanentemente todos os logs do sistema.</p>
        <button id="resetLogsBtn" class="btn btn-danger">
            <i class="fas fa-trash-alt me-2"></i>Resetar Todos os Logs
        </button>
    </div>
</div>

<div class="card settings-card">
    <div class="card-body">
        <h4 class="card-title mb-4">Gerenciamento de Sessões</h4>
        <p class="text-danger">Esta ação encerra todas as sessões ativas.</p>
        <button id="resetSessionsBtn" class="btn btn-warning">
            <i class="fas fa-power-off me-2"></i>Resetar Sessões
        </button>
    </div>
</div>

<div class="card settings-card mt-4">
    <div class="card-body">
        <h4 class="card-title mb-4">Exibição de Códigos</h4>
        <form id="codesLimitForm">
            <div class="mb-3">
                <label for="codesLimit" class="form-label">Quantidade de Códigos a Exibir</label>
                <input type="number" id="codesLimit" class="form-control" min="1" value="<%= codeLimit %>">
            </div>
            <button type="submit" class="btn btn-primary">Salvar</button>
        </form>
        <div id="codesLimitMessage" class="mt-3"></div>
    </div>
</div>

<div class="card settings-card mt-4">
    <div class="card-body">
        <h4 class="card-title mb-4">Auto-Recarregar Códigos</h4>
        <form id="reloadSettingsForm">
            <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" id="reloadEnabled" <%= reload.enabled ? 'checked' : '' %>>
                <label class="form-check-label" for="reloadEnabled">Ativar Auto-Recarregamento</label>
            </div>
            <div class="mb-3">
                <label for="reloadLimit" class="form-label">Limite de Recarregamentos</label>
                <input type="number" id="reloadLimit" class="form-control" min="1" value="<%= reload.limit %>">
            </div>
            <button type="submit" class="btn btn-primary">Salvar</button>
        </form>
        <div id="reloadSettingsMessage" class="mt-3"></div>
    </div>
</div>

<div class="card settings-card mt-4">
    <div class="card-body">
        <h4 class="card-title mb-4">Verificação por Código</h4>
        <form id="verificationFormSetting">
            <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" id="verificationEnabled" <%= verification.enabled ? 'checked' : '' %>>
                <label class="form-check-label" for="verificationEnabled">Exigir Código de Verificação</label>
            </div>
            <button type="submit" class="btn btn-primary">Salvar</button>
        </form>
        <div id="verificationMessage" class="mt-3"></div>
    </div>
</div>

<div class="card settings-card mt-4">
    <div class="card-body">
        <h4 class="card-title mb-4">Branding</h4>
        <form id="brandingForm" enctype="multipart/form-data">
            <div class="mb-3">
                <label for="panelName" class="form-label">Nome do Painel</label>
                <input type="text" id="panelName" class="form-control" value="<%= branding.panelName %>">
            </div>
            <div class="mb-3">
                <label for="panelLogoUrl" class="form-label">Logo do Painel (URL)</label>
                <input type="text" id="panelLogoUrl" class="form-control" value="<%= branding.panelLogoUrl %>">
                <input type="file" id="panelLogoFile" class="form-control mt-2">
            </div>
            <div class="mb-3">
                <label for="cardLogoUrl" class="form-label">Logo do Card (URL)</label>
                <input type="text" id="cardLogoUrl" class="form-control" value="<%= branding.cardLogoUrl %>">
                <input type="file" id="cardLogoFile" class="form-control mt-2">
            </div>
            <div class="mb-3">
                <label for="siteHref" class="form-label">Link da Página</label>
                <input type="text" id="siteHref" class="form-control" value="<%= branding.href %>">
            </div>
            <button type="submit" class="btn btn-primary">Salvar</button>
        </form>
        <div id="brandingMessage" class="mt-3"></div>
    </div>
</div>

<div class="card settings-card mt-4">
    <div class="card-body">
        <h4 class="card-title mb-4">Paleta de Cores</h4>
        <form id="colorsForm">
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Cor de Fundo Início</label>
                    <input type="color" id="bgStart" class="form-control form-control-color" value="<%= colors.bgStart %>">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Cor de Fundo Fim</label>
                    <input type="color" id="bgEnd" class="form-control form-control-color" value="<%= colors.bgEnd %>">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Início do Card</label>
                    <input type="color" id="cardStart" class="form-control form-control-color" value="<%= colors.cardStart %>">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Fim do Card</label>
                    <input type="color" id="cardEnd" class="form-control form-control-color" value="<%= colors.cardEnd %>">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Botão Principal</label>
                    <input type="color" id="buttonStart" class="form-control form-control-color" value="<%= colors.buttonStart %>">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Botão Hover</label>
                    <input type="color" id="buttonEnd" class="form-control form-control-color" value="<%= colors.buttonEnd %>">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Atualizar Início</label>
                    <input type="color" id="updateStart" class="form-control form-control-color" value="<%= colors.updateStart %>">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Atualizar Fim</label>
                    <input type="color" id="updateEnd" class="form-control form-control-color" value="<%= colors.updateEnd %>">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Cor do Texto</label>
                    <input type="color" id="textColor" class="form-control form-control-color" value="<%= colors.textColor %>">
                </div>
            </div>
            <button type="submit" class="btn btn-primary mt-3">Salvar</button>
        </form>
        <div id="colorsMessage" class="mt-3"></div>
    </div>
</div>

<!-- Reset Logs Confirmation Modal -->
<div class="modal fade" id="resetLogsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Reset de Logs</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Você tem certeza que deseja apagar todos os logs do sistema? Esta ação não pode ser desfeita.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmResetLogs">Confirmar Reset</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const resetLogsBtn = document.getElementById('resetLogsBtn');
        const resetLogsModal = new bootstrap.Modal(document.getElementById('resetLogsModal'));
        const confirmResetLogsBtn = document.getElementById('confirmResetLogs');
        const resetSessionsBtn = document.getElementById('resetSessionsBtn');
        const codesLimitForm = document.getElementById('codesLimitForm');
        const codesLimitInput = document.getElementById('codesLimit');
        const brandingForm = document.getElementById('brandingForm');
        const panelNameInput = document.getElementById('panelName');
        const panelLogoInput = document.getElementById('panelLogoUrl');
        const cardLogoInput = document.getElementById('cardLogoUrl');
        const panelLogoFile = document.getElementById('panelLogoFile');
        const cardLogoFile = document.getElementById('cardLogoFile');
        const hrefInput = document.getElementById('siteHref');
        const reloadForm = document.getElementById('reloadSettingsForm');
        const reloadEnabled = document.getElementById('reloadEnabled');
        const reloadLimit = document.getElementById('reloadLimit');
        const verificationForm = document.getElementById('verificationFormSetting');
        const verificationEnabled = document.getElementById('verificationEnabled');
        const colorsForm = document.getElementById('colorsForm');
        const bgStart = document.getElementById('bgStart');
        const bgEnd = document.getElementById('bgEnd');
        const cardStart = document.getElementById('cardStart');
        const cardEnd = document.getElementById('cardEnd');
        const buttonStart = document.getElementById('buttonStart');
        const buttonEnd = document.getElementById('buttonEnd');
        const updateStart = document.getElementById('updateStart');
        const updateEnd = document.getElementById('updateEnd');
        const textColor = document.getElementById('textColor');

        function updatePreview() {
            document.documentElement.style.setProperty('--bg-start', bgStart.value);
            document.documentElement.style.setProperty('--bg-end', bgEnd.value);
            document.documentElement.style.setProperty('--card-start', cardStart.value);
            document.documentElement.style.setProperty('--card-end', cardEnd.value);
            document.documentElement.style.setProperty('--button-start', buttonStart.value);
            document.documentElement.style.setProperty('--button-end', buttonEnd.value);
            document.documentElement.style.setProperty('--update-start', updateStart.value);
            document.documentElement.style.setProperty('--update-end', updateEnd.value);
            document.documentElement.style.setProperty('--text-color', textColor.value);
        }
        [bgStart, bgEnd, cardStart, cardEnd, buttonStart, buttonEnd, updateStart, updateEnd, textColor].forEach(el => {
            el.addEventListener('input', updatePreview);
        });
        updatePreview();

        codesLimitForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const val = parseInt(codesLimitInput.value);
            try {
                const res = await fetch('/admin/settings/code-display-limit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ limit: val })
                });
                if (res.ok) {
                    showMessage('codesLimitMessage', 'Limite salvo', 'success');
                } else {
                    showMessage('codesLimitMessage', 'Erro ao salvar limite', 'danger');
                }
            } catch (err) {
                showMessage('codesLimitMessage', 'Erro ao salvar limite', 'danger');
            }
        });

        brandingForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            try {
                const form = new FormData();
                form.append('panelName', panelNameInput.value);
                form.append('panelLogoUrl', panelLogoInput.value);
                form.append('cardLogoUrl', cardLogoInput.value);
                form.append('href', hrefInput.value);
                if (panelLogoFile.files[0]) form.append('panelLogoFile', panelLogoFile.files[0]);
                if (cardLogoFile.files[0]) form.append('cardLogoFile', cardLogoFile.files[0]);

                const res = await fetch('/admin/settings/branding', {
                    method: 'POST',
                    body: form
                });
                if (res.ok) {
                    showMessage('brandingMessage', 'Branding salvo', 'success');
                } else {
                    showMessage('brandingMessage', 'Erro ao salvar', 'danger');
                }
            } catch (err) {
                showMessage('brandingMessage', 'Erro ao salvar', 'danger');
            }
        });

        reloadForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const enabled = reloadEnabled.checked;
            const limit = parseInt(reloadLimit.value);
            try {
                const res = await fetch('/admin/settings/auto-reload', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled, limit })
                });
                if (res.ok) {
                    showMessage('reloadSettingsMessage', 'Configuração salva', 'success');
                } else {
                    showMessage('reloadSettingsMessage', 'Erro ao salvar', 'danger');
                }
            } catch (err) {
                showMessage('reloadSettingsMessage', 'Erro ao salvar', 'danger');
            }
        });

        verificationForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const enabled = verificationEnabled.checked;
            try {
                const res = await fetch('/admin/settings/email-verification', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled })
                });
                if (res.ok) {
                    showMessage('verificationMessage', 'Configuração salva', 'success');
                } else {
                    showMessage('verificationMessage', 'Erro ao salvar', 'danger');
                }
            } catch (err) {
                showMessage('verificationMessage', 'Erro ao salvar', 'danger');
            }
        });

        colorsForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const body = {
                bgStart: bgStart.value,
                bgEnd: bgEnd.value,
                cardStart: cardStart.value,
                cardEnd: cardEnd.value,
                buttonStart: buttonStart.value,
                buttonEnd: buttonEnd.value,
                updateStart: updateStart.value,
                updateEnd: updateEnd.value,
                textColor: textColor.value
            };
            try {
                const res = await fetch('/admin/settings/colors', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                if (res.ok) {
                    showMessage('colorsMessage', 'Cores salvas', 'success');
                } else {
                    showMessage('colorsMessage', 'Erro ao salvar', 'danger');
                }
            } catch (err) {
                showMessage('colorsMessage', 'Erro ao salvar', 'danger');
            }
        });

        function showMessage(id, msg, type) {
            const el = document.getElementById(id);
            el.className = `alert alert-${type}`;
            el.textContent = msg;
            setTimeout(() => { el.textContent = ''; el.className = ''; }, 3000);
        }



        resetLogsBtn.addEventListener('click', () => resetLogsModal.show());

        confirmResetLogsBtn.addEventListener('click', async function() {
            try {
                const response = await fetch('/admin/settings/reset-logs', { method: 'POST' });
                if (response.ok) {
                    resetLogsModal.hide();
                    location.reload();
                } else {
                    alert('Erro ao resetar logs.');
                }
            } catch (error) {
                alert('Erro ao resetar logs.');
            }
        });

        resetSessionsBtn.addEventListener('click', async function() {
            if(confirm('Deseja encerrar todas as sessões ativas?')) {
                try {
                    const response = await fetch('/admin/settings/reset-sessions', { method: 'POST' });
                    if (response.ok) {
                        alert('Sessões resetadas');
                    } else {
                        alert('Erro ao resetar sessões');
                    }
                } catch (error) {
                    alert('Erro ao resetar sessões');
                }
            }
        });

    });
</script>
